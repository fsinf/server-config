#!/bin/bash

set -e
hostname=$1
RESTART=${RESTART:-y}

if [[ -z "$hostname" ]]; then
    echo "Usage: $0 [hostname]"
    exit 1
fi

# chdir to basedir
cd /etc/ssl

key=private/$hostname.key
csr=$hostname.csr
pem=public/$hostname.pem

if [[ -e "$key" ]]; then
    mv --backup=numbered $key $key.backup
fi
if [[ -e "$pem" ]]; then
    mv --backup=numbered $pem $pem.backup
fi

# set umask
umask 0027

subject="/C=AT/ST=Vienna/L=Vienna/O=Österreichische HochschülerInnenschaft/OU=Fachschaft Informatik/emailAddress=root@fsinf.at/CN=$hostname/"

# generate private key
sg ssl-cert -c "openssl genrsa -out $key 4096" > /dev/null 2> /dev/null
sg ssl-cert -c "openssl req -new -key $key -out $csr -utf8 -batch -sha256 -subj '$subject'" > /dev/null
cat $csr

read

# set umask to world-readable again (.pem are not secret)
umask 0022

vim $pem

rm $csr

if [[ $RESTART == "y" ]]; then
    apache2ctl -t && /etc/init.d/apache2 restart
fi

openssl x509 -noout -in $pem -fingerprint -md5
openssl x509 -noout -in $pem -fingerprint -sha1
openssl x509 -noout -in $pem -fingerprint -sha256
openssl x509 -noout -in $pem -fingerprint -sha512
